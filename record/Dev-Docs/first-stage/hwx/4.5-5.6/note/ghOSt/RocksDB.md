## ç¡¬ä»¶ç¯å¢ƒ

> The experiments run on a single socket from a 2-socket Intel Xeon CPU E5-2658 (12 cores per socket, 24 logical cores per socket, 2.2 GHz)

æœ¬æ¬¡å®éªŒè·‘åœ¨ä¸€ä¸ª2-socket CPUçš„å…¶ä¸­ä¸€ä¸ªsocketä¸Šï¼Œè¿™ä¸ªsocketå…±æœ‰12ä¸ªç‰©ç†coreï¼Œ24ä¸ªlogical coreã€‚

åŒä¸€ä¸ªsocketï¼ˆl3 slibingï¼‰å…±äº«l3cacheï¼ŒåŒä¸€ä¸ªcoreï¼ˆslibingï¼‰å…±äº«l1 l2cache

threadã€cpuï¼ˆprocesserï¼‰ã€coreã€socketã€node

socket=NUMA node

## æ•°é‡å…³ç³»

applicationè¿›ç¨‹ã€prio tableã€sched itemã€work classã€çº¿ç¨‹

1. ä¸€ä¸ªapplicationæ‹¥æœ‰å¤šä¸ªçº¿ç¨‹
2. ä¸€ä¸ªapplicationå¯¹åº”ä¸€ä¸ªprio table
3. ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªsched item
4. å› è€Œï¼Œä¸€ä¸ªapplicationæœ‰å¤šå°‘ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå®ƒæ‹¥æœ‰çš„prio tableå°±æœ‰å¤šå°‘ä¸ªsched itemï¼Œsched itemæ•°ç»„å°±æœ‰å¤šå°‘ä¸ªå…ƒç´ 
5. work classè¡¨ç¤ºå¯¹taskè¿›è¡Œåˆ†ç±»ï¼Œæ‰€ä»¥ä¸€ä¸ªwork classåŒ…å«å¤šä¸ªtaskï¼›ä¸€ä¸ªtask åªèƒ½å±äºä¸€ä¸ªwork class
6. work classç”±ç”¨æˆ·è‡ªå®šä¹‰ï¼Œæ‰€ä»¥ç”¨æˆ·æƒ³å®šä¹‰å¤šå°‘ä¸ªå°±å®šä¹‰å¤šå°‘ä¸ª



shinjuku schedulerã€applicationè¿›ç¨‹ã€prio tableã€shinjuku orchastrator

1. ä¸€ä¸ªshinjuku agentç«¯å¯ä»¥ä¸ºå¤šä¸ªapplicationæä¾›æœåŠ¡
2. ä¸€ä¸ªapplicationæ‹¥æœ‰ä¸€å¼ prio tableã€‚
3. shinjuku orchestratorç±»ç”¨æ¥åŒ…è£…ç®¡ç†prio tableã€‚ä¸€ä¸ªshinjuku orchestratorå¯¹åº”ä¸€ä¸ªprio table      
4. shinjuku schedulerç®¡ç†å¤šä¸ªorchastratorã€‚æ•°æ®ç»“æ„ï¼š`<applicationçš„pid, orchastrator>`map
5. å› è€Œï¼Œ**ä¸€ä¸ªshinjuku schedulerâ€”â€”å¤šä¸ªapplicationâ€”â€”å¤šä¸ªorchastratorâ€”â€”å¤šä¸ªprio table**



workerã€load generatorã€thread pool

1. ä¸€ä¸ªload generatorçº¿ç¨‹ã€6ï¼ˆé»˜è®¤å€¼ï¼‰ä¸ªworkerçº¿ç¨‹
2. load generatorè¢«å›ºå®šåœ¨ä¸€ä¸ªcpuä¸Šè¿è¡Œ
3. sizeof(çº¿ç¨‹æ± ) = 7 = 1+6

## ä¸¤ç§çº¿ç¨‹

![image-20230424145654784](./img/RocksDB/image-20230424145654784.png)

![image-20230424154311322](./img/RocksDB/image-20230424154311322.png)

### äº¤äº’ç»†èŠ‚

##### æ²‰ç¡-å”¤é†’æœºåˆ¶çš„å®ç°

ä½¿ç”¨PrioTableå®ç°ã€‚

1. å¦‚æœworkerçº¿ç¨‹éœ€è¦æ²‰ç¡ï¼Œå®ƒåªéœ€åœ¨PrioTableä¸­æ ‡è®°è‡ªå·±çš„çŠ¶æ€ä¸ºIDLEå³å¯ã€è°ƒç”¨`prio_table_helper_->MarkIdle(sid)`ã€‘

2. **Agentåœ¨è¿›è¡Œè°ƒåº¦å†³ç­–æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥PrioTableä¸­çš„æ ‡å¿—ï¼Œç„¶åè·³è¿‡çŠ¶æ€ä¸ºIDLEçš„workerçº¿ç¨‹ã€‚**

3. load generatoråœ¨PrioTableä¸­æ ‡è®°workerçš„çŠ¶æ€ä¸ºRunnableã€è°ƒç”¨`prio_table_helper_->MarkRunnable(sid)`ã€‘ï¼Œå³å¯è®©workerçº¿ç¨‹å†æ¬¡èƒ½å¤Ÿè¢«Agentè°ƒåº¦ã€‚

### PrioTable

æ€ä¹ˆä¸²è”é€šä¿¡

### load generator

network

å¢åŠ å¢åˆ 

å…¶ç”Ÿæˆçš„requestæµçš„ç‰¹ç‚¹ï¼šingressã€network

1. å¹³å‡ååé‡throughputä¿æŒå®šå€¼ï¼Œè¿™ä¸ªå®šå€¼ä¸ºç”¨æˆ·è§„å®šï¼›ä½†ç¬æ—¶ååé‡æœä»æ³Šæ¾åˆ†å¸ƒ

2. ç”Ÿæˆçš„è¯·æ±‚keyæ˜¯éšæœºæ•°ï¼ŒèŒƒå›´ä¸º1-kNumEntriesï¼ˆ1000000ï¼‰

### worker

1. ä¸»è¦è°ƒç”¨`HandleRequest`æ¥å¤„ç†sqlè¯·æ±‚

2. æ¯ä¸ªworkerå…·ä½“å·¥ä½œï¼š

   1. æ ¹æ®ä¼ å…¥çš„requestå‚æ•°æ‰§è¡Œsqlè¯·æ±‚

   2. æ¯ä¸ªworkerè‡³å°‘è¦æ‰§è¡Œoptions_.get_durationæ—¶é—´

      > åœ¨è®ºæ–‡ä¸­ï¼Œè¿™ä¸ªæ‰€è°“çš„`get_duration`å‚æ•°çš„å–å€¼åº”è¯¥æ˜¯è¿™æ ·ï¼š
      >
      > We assigned the following processing times: **99.5% of requests - 4 *ğœ‡*s, 0.5% of requests - 10 ms**. 
      >
      > ä½†æˆ‘æ²¡å…·ä½“çœ‹å‡ºæ¥è¿™ä¸ªæ¯”ä¾‹æ˜¯å“ªæ¥çš„ï¼Œmainé‡Œé¢`get_duration`å‚æ•°çš„é»˜è®¤å€¼æ˜¯10msã€‚

3. æ¯ä¸ªworkeræœ‰preemption time slice  30Î¼s

   > The allotted time slice per worker thread, before forcing a preemption and returning back to the FIFO, is 30 *ğœ‡*s.

## æŒ‡æ ‡è®¡ç®—

1. Requestç»“æ„ä½“

   ```c++
   // A synthetic request for RocksDB generated by 'Ingress'.
   struct Request {
     // When the request was generated.
     absl::Time request_generated;  // è®°å½•requeståœ¨ingressæµçš„ç”Ÿæˆæ—¶é—´
     // When the request was picked up by the app.
     absl::Time request_received;  // è®°å½•requestè¢«networkæ¥æ”¶åˆ°çš„æ—¶é—´
     // When the request was assigned to a worker.
     absl::Time request_assigned;  // è®°å½•requestè¢«generatoråˆ†é…ç»™workerçš„æ—¶é—´
     // When the request started to be handled by a worker.
     absl::Time request_start; // è®°å½•requestå¼€å§‹è¢«workerå¤„ç†çš„æ—¶é—´
     // When the worker finished handling the request.
     absl::Time request_finished;  // è®°å½•requestç»“æŸè¢«workerå¤„ç†çš„æ—¶é—´
   
     // The work to do. The request is either a Get request or a Range query.
     std::variant<Get, Range> work;
   };
   ```

2. stageåˆ’åˆ†

   å›å¿†requestçš„ç”Ÿå‘½å‘¨æœŸï¼šingress-network-generator-worker

   ```c++
   // Prints all results.
   void Print(const std::vector<Request>& requests, absl::Duration runtime,
              PrintOptions options) {
     if (!options.print_last) {
       // ä»requeståœ¨ingressæµç”Ÿæˆï¼Œåˆ°è¢«generatorè°ƒç”¨Pollæ¥æ”¶çš„æ—¶é—´
       /*
       1. generatorå¯»æ‰¾ç©ºé—²workerï¼Œå¡«å…¥idle sidsä¸­
       2. generatoræ›´æ–°workerçŠ¶æ€
       3. å¾ªç¯éå†workerï¼Œè°ƒç”¨poll
       è¿™ä¸ªè¿‡ç¨‹å–å†³äºç©ºé—²workerçš„æ•°é‡
       ç©ºé—²workerè¶Šå¤šï¼Œæ›´å¤šçš„requestå°±èƒ½å°½å¿«è¢«assign
       æ¯ä¸ªworkeréƒ½æ˜¯ä¸€è·¯å¹²åˆ°åº•çš„ï¼Œè€Œè¿™ä¸ªç©ºé—²å¿…é¡»ä¸ºç©º
       æ‰€ä»¥ä¸ºäº†åŠ é€Ÿè¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦è®©æ¯æ¬¡generatorå¯»æ‰¾ç©ºé—²workerï¼Œå¾—åˆ°çš„ç©ºé—²workeræ•°å°½å¯èƒ½å¤š
       æˆ‘ä»¬çš„è°ƒåº¦ç­–ç•¥å°±éœ€è¦è€ƒè™‘è¿™ä¸€ç‚¹ï¼Œæ¯”å¦‚è¯´ä¼˜å…ˆè°ƒåº¦é‚£äº›æœ€æœ‰å¸Œæœ›ç©ºé—²çš„worker
       */
       HANDLE_STAGE("Ingress Queue Time", requests, runtime, request_generated,
                    request_received, options);
       // ä»generatorè°ƒç”¨Pollï¼Œåˆ°generatoråˆ†é…ç»™workerçš„æ—¶é—´
       /*
       1. æ„é€ request.work
       è¿™ä¸ªè¿‡ç¨‹æ„Ÿè§‰æ²¡ä»€ä¹ˆå¥½æ§åˆ¶çš„
       */
       HANDLE_STAGE("Repeatable Handle Time", requests, runtime, request_received,
                    request_assigned, options);
       // ä»workeræ¥æ”¶ï¼Œåˆ°requeståˆ°workerå¼€å§‹å¤„ç†requestçš„æ—¶é—´
       /*
       1. generatoråˆ†é…requestç»™worker
       2. generatoræ ‡è®°workerçŠ¶æ€ä¸ºrunnable
       3. schedulerè¯»å–prio tableï¼Œæ›´æ–°workerä»»åŠ¡çš„çŠ¶æ€ï¼Œå°†workerçº³å…¥run queue
       4. workerä»runqueueä¸­è¢«pickè°ƒåº¦
       è¿™ä¸€æ­¥è·Ÿè°ƒåº¦ç®—æ³•å…³ç³»æœ€ä¸ºå¯†åˆ‡ã€‚è¦æ±‚3å°½å¿«ä¸ºå¥½ï¼Œæ²¿ç”¨centralized modelçš„åšæ³•ï¼šåœ¨
       AgentThreadå¾ªç¯ä½“ä¸­ä¸æ–­æ£€æŸ¥
       */
       HANDLE_STAGE("Worker Queue Time", requests, runtime, request_assigned,
                    request_start, options);
       // workerå¤„ç†requestçš„æ—¶é—´
       /*
       1. workerå¤„ç†sql
       2. workerè‡³å°‘éœ€è¦å¤„ç†service time
       åœ¨è¿™æœŸé—´ï¼Œè°ƒåº¦ç®—æ³•å¯èƒ½ä¼šä¸­æ–­workerè¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¤§æŠµé‡‡ç”¨çš„æ˜¯time sliceï¼Œè®ºæ–‡ä¸­è¦æ±‚
       æ—¶é—´ä¸Šç•Œä¸º30Î¼s
       */
       HANDLE_STAGE("Worker Handle Time", requests, runtime, request_start,
                    request_finished, options);
     }
     // Total time in system
     HANDLE_STAGE("Total", requests, runtime, request_generated, request_finished,
                  options);
   }
   ```

3. Resultç»“æ„ä½“

   å¯¹æ¯ä¸ªstageï¼Œéƒ½è¦è®¡ç®—ä¸€æ¬¡Resultç»“æ„ä½“å†…çš„æ‰€æœ‰å­—æ®µ

   ```c++
   template <class T>
   struct Results {
     // The total number of requests.
     T total;
     // The throughput;
     T throughput;// 
     // The min latency.
     T min;
     // The 50th percentile latency.
     T fifty;
     // The 99th percentile latency.
     T ninetynine;
     // The 99.5th percentile latency.
     T ninetyninefive;
     // The 99.9th percentile latency.
     T ninetyninenine;
     // The max latency.
     T max;
   };
   ```

### throughput

å¹³å‡

```c++
  // throughput = ï¼ˆè¯·æ±‚æ•°/æ‰€æœ‰è¯·æ±‚è¿è¡Œæ—¶é—´ï¼‰
  results.throughput =
      (total / absl::ToDoubleMilliseconds(runtime)) * 1000;
```

### latency

tail latencyï¼šæ„æ€å°±æ˜¯è¯´é‚£ä¹ˆå°‘è§çš„ä½†åˆå¾ˆå¤§çš„å»¶è¿Ÿï¼ŒåŸºæœ¬å¯ä»¥ç†è§£ä¸ºä¸€æ‰¹æ“ä½œé‡Œé¢å›é¦ˆæœ€æ…¢çš„é‚£å‡ ä¸ªã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚è¯´ä½ ç”¨çŸ¥ä¹çš„æœç´¢å¼•æ“æœäº†å¥½å‡ æ¬¡ä¸œè¥¿ï¼Œç„¶åæœ‰å‡ æ¬¡çš„åé¦ˆæ…¢çš„ç¦»è°±ï¼Œè¿™ä¸ªå°±æ˜¯tail latencyã€‚

```c++
  // æ³¨æ„ï¼Œdurationæ˜¯ä»å°åˆ°å¤§æ’åºçš„ï¼Œæ‰€ä»¥frontå°±æ˜¯min
  results.min = durations.front() / divisor;
  // è¿™æ˜¯ç”¨ä¸­ä½æ•°ç®—çš„ï¼Ÿ6
  // å…¶å®ä¹Ÿä¸ç®—å§ï¼Œæ¯•ç«Ÿlatencyçš„æ¦‚å¿µæ˜¯æ‹–åè…¿éƒ¨åˆ†
  // é‚£ä¹ˆå‰50%è¯·æ±‚çš„æ‹–åè…¿éƒ¨åˆ†è‡ªç„¶å°±æ˜¯ç¬¬50%çš„é‚£ä¸ªè¯·æ±‚äº†
  results.fifty = durations.at(size * 0.5) / divisor;
  results.ninetynine = durations.at(size * 0.99) / divisor;
  results.ninetyninefive = durations.at(size * 0.995) / divisor;
  results.ninetyninenine = durations.at(size * 0.999) / divisor;
  results.max = durations.back() / divisor;
```

## å¯åŠ¨åˆ†æ

æˆ‘æ›¹ï¼Œæ³¨æ„åˆ°ï¼š

![image-20230427232824289](./img/RocksDB/image-20230427232824289.png)

ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯åŠ¨workerçº¿ç¨‹ä¹‹å‰ï¼Œä¼šå…ˆæ‰§è¡ŒTaskNew-HandleNewGtidï¼

workerçº¿ç¨‹å¼€å§‹æ‰§è¡Œ-GhostThreadæ„é€ ï¼Œé€šè¿‡SchedTaskEnterGhostï¼Œå†…æ ¸å°±ä¼šæŠŠTaskNewä¿¡æ¯æ”¾è¿›æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒAgentThreadæ‰§è¡ŒDispatchMessageï¼Œåœ¨é‡Œé¢æ–°å»ºäº†ä¸€ä¸ªtaskç»“æ„ä½“ï¼Œç„¶åè¿›å…¥TaskNewï¼Œç„¶åtaskçš„çŠ¶æ€è¢«è®¾ç½®ä¸ºblockedã€‚ç›´åˆ°å¤–ç•Œå°†å…¶priotableä¿®æ”¹ä¸ºrunnableçŠ¶æ€ï¼Œç„¶åagenthreadä¸­åœ¨SchedParamsCallbackä¸­copy äº†sched itemçš„å¤‡ä»½ï¼Œå¯¹å…¶çŠ¶æ€è¿›è¡Œæ›´æ–°ï¼Œæ‰èƒ½å†æ¬¡è¢«agentè°ƒç”¨ï¼

è€Œä¸”è¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œè¿™ä¸€æ­¥é™¤äº†åˆ›å»ºtaskä¹‹å¤–ï¼Œè¿˜åˆ›å»ºäº†orch

1. orchç®¡ç†prio table

2. ä¸€ä¸ªappå¯¹åº”ä¸€ä¸ªorch

3. è€Œæ­¤å¤„æ˜¯appçš„çº¿ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®scheduler

4. æ‰€ä»¥éœ€è¦ä¸ºå…¶åˆ›å»ºorch

5. æ¦‚å¿µï¼štgid  thread group identifierï¼Œå­˜å‚¨åœ¨/proc/è¿›ç¨‹pid/statusæ–‡ä»¶ä¸­

   <img src="./img/RocksDB/image-20230428192008191.png" alt="image-20230428192008191" style="zoom:50%;" />

## æ€»ç»“ï¼šå¯¹Agentçš„è¦æ±‚

1. å¿…é¡»ä¸ºcentralized model

2. å»ºè®®æ”¯æŒPrioTableé€šä¿¡

3. ä¼¼ä¹è¦æ”¯æŒæŠ¢å è°ƒåº¦

   è®ºæ–‡çš„å®éªŒåœºæ™¯è¦æ±‚30Î¼sä¸ºpreemption time sliceã€‚